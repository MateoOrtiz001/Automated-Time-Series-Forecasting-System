# =============================================================================
# GitHub Actions Workflow: Monthly Pipeline
# =============================================================================
# Este workflow ejecuta el pipeline de predicción de inflación mensualmente
# usando Docker como runtime para garantizar reproducibilidad.
# 
# Ejecución:
#   - Automática: Día 5 de cada mes a las 10:00 UTC
#   - Manual: Desde la pestaña Actions > Run workflow
#
# Proceso:
#   1. Construye imagen Docker con todas las dependencias
#   2. Ejecuta tests rápidos de imports dentro del contenedor
#   3. Ejecuta el pipeline mensual dentro del contenedor
#   4. Actualiza archivos latest.csv para el dashboard
#   5. Commit y push de los cambios
#   6. Streamlit Cloud detecta el push y re-deploya automáticamente
# =============================================================================

name: Monthly Pipeline

on:
  # Ejecutar el día 5 de cada mes a las 10:00 UTC (5:00 AM Colombia)
  schedule:
    - cron: '0 10 5 * *'
  
  # Permitir ejecución manual desde GitHub
  workflow_dispatch:
    inputs:
      force_finetune:
        description: 'Force model fine-tuning'
        required: false
        default: 'false'
        type: boolean
      skip_tests:
        description: 'Skip tests (faster but riskier)'
        required: false
        default: 'false'
        type: boolean

# Permisos necesarios para hacer push
permissions:
  contents: write

env:
  DOCKER_IMAGE: inflation-forecast
  DOCKER_TAG: ${{ github.sha }}

jobs:
  # ===========================================================================
  # Job 1: Build Docker Image
  # ===========================================================================
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    outputs:
      image_name: ${{ steps.build.outputs.image_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('requirements.txt', 'Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build Docker image
        id: build
        run: |
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} \
            -t ${{ env.DOCKER_IMAGE }}:latest \
            .
          
          echo "image_name=${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}" >> $GITHUB_OUTPUT
          echo " Docker image built successfully"
      
      # Mover cache para evitar crecimiento infinito
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Save Docker image as artifact
        run: |
          docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} | gzip > /tmp/docker-image.tar.gz
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar.gz
          retention-days: 1

  # ===========================================================================
  # Job 2: Run Tests in Container
  # ===========================================================================
  test:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
      
      - name: Load Docker image
        run: |
          gunzip -c /tmp/docker-image.tar.gz | docker load
          echo " Docker image loaded"
      
      - name: Run quick import tests
        run: |
          docker run --rm \
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} \
            test-quick
          echo " Import tests passed"
      
      - name: Run integration tests (if exist)
        continue-on-error: true
        run: |
          docker run --rm \
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} \
            test || echo " No pytest tests found or tests failed (non-blocking)"

  # ===========================================================================
  # Job 3: Run Pipeline
  # ===========================================================================
  run-pipeline:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: always() && needs.build.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
      
      - name: Load Docker image
        run: |
          gunzip -c /tmp/docker-image.tar.gz | docker load
          echo " Docker image loaded"
      
      - name: Create directories
        run: |
          mkdir -p data/raw/banrep/suameca
          mkdir -p data/raw/external
          mkdir -p data/proc
          mkdir -p misc/models
          mkdir -p misc/results
          mkdir -p misc/logs
      
      - name: Run monthly pipeline in Docker
        run: |
          # Preparar argumentos
          PIPELINE_ARGS=""
          if [ "${{ github.event.inputs.force_finetune }}" == "true" ]; then
            PIPELINE_ARGS="--finetune"
          fi
          
          echo " Running pipeline with args: $PIPELINE_ARGS"
          
          # Ejecutar pipeline en contenedor con volúmenes montados
          docker run --rm \
            -v "${{ github.workspace }}/data:/app/data" \
            -v "${{ github.workspace }}/misc:/app/misc" \
            -v "${{ github.workspace }}/models:/app/models" \
            -v "${{ github.workspace }}/results:/app/results" \
            -v "${{ github.workspace }}/src/pipeline:/app/src/pipeline" \
            -e TF_CPP_MIN_LOG_LEVEL=2 \
            -e TF_ENABLE_ONEDNN_OPTS=0 \
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} \
            pipeline $PIPELINE_ARGS
          
          echo " Pipeline completed successfully"
      
      - name: Update latest files for dashboard
        run: |
          # Copiar el CSV de datos más reciente a latest.csv
          latest_csv=$(ls -t data/proc/*.csv 2>/dev/null | grep -v latest.csv | head -1)
          if [ -n "$latest_csv" ]; then
            cp "$latest_csv" data/proc/latest.csv
            echo " Copied $latest_csv to data/proc/latest.csv"
          fi
          
          # Copiar las predicciones más recientes
          latest_pred=$(ls -t misc/results/predictions_*.csv 2>/dev/null | grep -v latest | head -1)
          if [ -n "$latest_pred" ]; then
            cp "$latest_pred" misc/results/predictions_latest.csv
            echo " Copied $latest_pred to misc/results/predictions_latest.csv"
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Agregar archivos actualizados
          git add data/proc/latest.csv || true
          git add misc/results/predictions_latest.csv || true
          git add src/pipeline/pipeline_state.json || true
          
          # Solo commit si hay cambios
          if git diff --staged --quiet; then
            echo " No changes to commit"
          else
            git commit -m " Monthly update: $(date +'%Y-%m-%d') [Docker pipeline]"
            git push
            echo " Changes pushed successfully"
          fi
      
      - name: Job summary
        run: |
          echo "##  Monthly Pipeline Results (Docker)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Build:  Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Files" >> $GITHUB_STEP_SUMMARY
          echo "- Latest data: \`data/proc/latest.csv\`" >> $GITHUB_STEP_SUMMARY
          echo "- Predictions: \`misc/results/predictions_latest.csv\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline State" >> $GITHUB_STEP_SUMMARY
          if [ -f "src/pipeline/pipeline_state.json" ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat src/pipeline/pipeline_state.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
